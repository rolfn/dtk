# Rolf Niepraschk, 2015/07/14, Rolf.Niepraschk@gmx.de
#
# Hilfsdefinitionen zum make-Prozess für "Die TeXnische Komödie"
#
# -- unveränderlich --

## Generalized rule: how to build a .pdf from each .tex     ## !!! ???
LATEXPDFS=$(patsubst %.tex,%.pdf,$(wildcard *.tex))
##$(LATEXPDFS): %.pdf: %.tex
##	pdflatex -interaction nonstopmode $(patsubst %.pdf,%.tex,$@)

LATEX = lualatex
LATEX = pdflatex
LATEX_OPTS = "--shell-escape"

MAKEINDEXSTYLE = dtk-idx.ist
MAKEGLOSSARYSTYLE = dtk-adr.ist

IDX_STYLE = dtk.xdy
MAKEINDEX = xindy -v -C utf8 -M $(IDX_STYLE) -L general -I latex
BIBTEX = biber
GREP = grep

TEMP_EXT = .log .aux .blg .toc .bbl .bcf .idx .ind .run.xml

bibtexwarn = 'Please (re)run Biber on the file'
rerunwarn = 'Rerun to get cross-references right'
linenowarn = 'Linenumber reference failed'

# TODO: Test, ob "biber", "xindy"
$(MAIN).pdf : $(MAIN).tex userpackages.tex $(ARTICLES)
	$(LATEX) $(LATEX_OPTS) $<
	@ if $(GREP) $(bibtexwarn) $(basename $<).log > /dev/null; \
	  then $(BIBTEX) $(basename $<); fi;
	$(MAKEINDEX) $(basename $<)-addresses.idx -o $(basename $<)-addresses.ind
	$(LATEX) $(LATEX_OPTS) $<

record : userpackages.tex

userpackages.tex : $(MAIN)0.tex
	pdflatex -draftmode -interaction=nonstopmode $<

clean :
	$(RM) $(foreach i, $(wildcard *.tex), $(addprefix $(basename $i), $(TEMP_EXT)))
	$(RM) $(MAIN)-addresses.idx $(MAIN)-addresses.ind  userpackages.tex

veryclean : clean
	$(RM) $(foreach i, $(wildcard *.tex), $(addprefix $(basename $i), .pdf)) \
