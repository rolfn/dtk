# Rolf Niepraschk, 2015/09/28, Rolf.Niepraschk@gmx.de
#
# Hilfsdefinitionen zum make-Prozess für "Die TeXnische Komödie"
#
# -- unveränderlicher Teil --

LOCAL_PATH = ./texmf/

ifeq ($(filter x,$(MAKECMDGOALS)),)
  LATEX = TEXINPUTS=$(LOCAL_PATH): lualatex
else
  LATEX = TEXINPUTS=$(LOCAL_PATH): pdflatex
  XTARGET = $(filter-out x,$(MAKECMDGOALS))
  ifeq ($(XTARGET),)
    XTARGET = $(.DEFAULT_GOAL)
  endif
endif
LATEX_OPTS = --shell-escape

IDX_STYLE = $(LOCAL_PATH)dtk.xdy
XINDY = xindy -v -C utf8 -L general -I latex -M $(IDX_STYLE)
BIBTEX = biber
EGREP = grep -E

TEMP_EXT = .log .aux .blg .toc .bbl .bcf .idx .ind .run.xml .urls

BIBTEX_WARN = (run Biber on the file)
RERUN_WARN1 = Rerun to get cross-references right
RERUN_WARN2 = Please rerun LaTeX
RERUN_WARN3 = There were undefined references
RERUN_WARN4 = Linenumber reference failed
RERUN_WARNINGS = ($(RERUN_WARN1)|$(RERUN_WARN2)|$(RERUN_WARN3)|$(RERUN_WARN4))

MAX_LTX_RUNS = 3

ADDINPUTS += $(addprefix $(LOCAL_PATH), dtk2.cls dtk.bbx dtk.cbx dtk-full.clo \
  dtk-new-engines.clo dtk-old-engines.clo komoedie0.tex ruecken.tex dtk.nolig) \
  $(IDX_STYLE)

all : $(MAIN).pdf

x : $(XTARGET)

userpackages userpackages.tex :
	TEXINPUTS=$(LOCAL_PATH): pdflatex -draftmode -interaction=nonstopmode $(MAIN)0.tex

$(MAIN).pdf : $(MAIN).tex userpackages.tex $(ARTICLES) $(ADDINPUTS)
	if test -f $(basename $<)-addresses.idx; \
	  then cp $(basename $<)-addresses.idx $(basename $<)-addresses.idx.old; \
	  else touch $(basename $<)-addresses.idx.old; fi;
	if test -f ruecken.dat; \
	  then cp ruecken.dat ruecken.dat.old; \
	  else touch ruecken.dat.old; fi;
	$(LATEX) $(LATEX_OPTS) $<
	if ! diff $(basename $<)-addresses.idx $(basename $<)-addresses.idx.old \
	  > /dev/null; then $(XINDY) $(basename $<)-addresses.idx \
	  -o $(basename $<)-addresses.ind; fi;
	if ! diff ruecken.dat ruecken.dat.old > /dev/null; \
	  then TEXINPUTS=$(LOCAL_PATH): pdflatex ruecken.tex; fi;
	if $(EGREP) '$(BIBTEX_WARN)' $(basename $<).log > /dev/null; \
	  then $(BIBTEX) $(basename $<); fi;
	for (( i=0; i < $(MAX_LTX_RUNS); i++ )) do \
	  if $(EGREP) '$(RERUN_WARNINGS)' $(basename $<).log > /dev/null; \
	  then $(LATEX) $(LATEX_OPTS) $<; fi; \
	done

clean :
	$(RM) $(foreach i, $(wildcard *.tex), $(addprefix $(basename $i), $(TEMP_EXT)))
	$(RM) $(MAIN)-addresses.idx $(MAIN)-addresses.idx.old $(MAIN)-addresses.ind \
	  ruecken.dat ruecken.dat.old ruecken.log ruecken.aux userpackages.tex \
	  komoedie0.log komoedie0.run.xml

veryclean : clean
	$(RM) $(foreach i, $(wildcard *.tex), $(addprefix $(basename $i), .pdf)) \
	  ruecken.pdf
